<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="exploit_data.js"></script>

<!-- Create a div where the graph will take place -->
<div id="exploit_container">
    <div id="exploit_div"></div>
</div>

<style>
    
    #exploit_div{
        display: flex;
        flex-wrap: wrap;
        border: solid;
    }
    #exploit_container{
        display: flex;
        flex-direction: row;
    }
    #UIDs_list{
        background-color: beige;
        
        
    }
</style>


<script>
    var max_str = ""
    drawMultipleHisto()
    function drawMultipleHisto(){
        d3.select("#UIDs_list").remove();
        for (const key in exploit_data) {
            if (Object.hasOwnProperty.call(exploit_data, key)) {
                const element = exploit_data[key];
                if(key.length>max_str.length) max_str = key
            }
        }
        console.log(max_str)
        for (const key in exploit_data) {
            if (Object.hasOwnProperty.call(exploit_data, key)) {
                const element = exploit_data[key];
                drawSingleHisto(element,key)
            }
        }
    } 

function drawSingleHisto(data,method){
    // set the dimensions and margins of the graph
    var margin_exploit = {top: 15, right: 0, bottom: 20, left: 10},
        width_exp = 210 - margin_exploit.left - margin_exploit.right,
        heightexp = 150 - margin_exploit.top - margin_exploit.bottom;
    
    // append the svg object to the body of the page
    var svg_single_chart = d3.select("#exploit_div")
      .append("svg").attr("id",method)
        .attr("width", width_exp + margin_exploit.left + margin_exploit.right)
        .attr("height", heightexp + margin_exploit.top + margin_exploit.bottom)
        .style("border-color","black")
        .style("border-style","solid")
        .style("margin","5px")
      .append("g")
        .attr("transform",
              "translate(" + margin_exploit.left + "," + margin_exploit.top + ")");
    
    // Parse the Data
    
    // X axis
    var si = d3.scaleLinear().domain([0,5]).range([12,6]) //scala per il font size della x
    var pad = d3.scaleLinear().domain([2,4]).range([0.5,0.2]) //scala per il padding
    pad = pad(data.length)
    var x_exp = d3.scaleBand()
      .range([ 0, width_exp ])
      .domain(data.map(function(d) { return d.eod; }))
      .padding(pad)//0.2
      //.padding(function(d) { return pad(data.length); })
      .paddingInner(0.5);
    svg_single_chart.append("g")
      .attr("transform", "translate(0," + heightexp + ")")
      .call(d3.axisBottom(x_exp))
      .selectAll("text")
        .style("text-anchor", "center")
        .style("font-size",si(data.length)+"px")
        
            
    // Add Y axis
    var maxY = 0
    data.forEach(element => {
        if(element.Value > maxY) maxY = element.Value
    });
    var y_exp = d3.scaleLinear()
      .domain([0, maxY])
      .range([ heightexp, 0]);
    svg_single_chart.append("g")
      .call(d3.axisLeft(y_exp).ticks(0))
     .attr("opacity","0");
      
    //label method (canary,...)
    si = d3.scaleLinear().domain([0,max_str.length]).range([18,10]) //scala per il font size della x
      svg_single_chart.append("text")
        .text(function(d) { return method.replace("_"," ")})
        .attr("transform", "translate(10,50)rotate(-90)")
        .style("text-anchor", "middle")
        .style("font-size",si(method.length)+"px")

    // Bars
    var bar = svg_single_chart.selectAll("mybar")
      .data(data)
      .enter()
      .append("g")
      

    //ONclick  
    var expandBar = function (d){
        var div_w = d3.select("#exploit_div").style("width")
        var div_h = d3.select("#exploit_div").style("height")
        var e = d3.select("#exploit_container").selectAll("svg").filter(function() {
            return d3.select(this).attr("id") != method;  // Use a filter to select all other bars for the transition.
            })
        e.remove()
        var list = d3.select("#exploit_container").append("div").attr("id","UIDs_list");
        list
            .style("height","0px")
            .style("width","0px")
            .transition()
            .style("height",div_h)
            .style("width",div_w)
            .style("background-color",d3.select(this).attr("fill"))
        
        d.UIDs.forEach(uid => {
            list.append("text").text(uid).style("font-size","10px")
            list.append("br")
        });
        console.log(d)
        list.on("click",function(d){drawMultipleHisto()})
    }

    var MoverBar = function (d){d3.select(this).style("stroke-width", "3px").style("stroke","black")}
    var MleaveBar = function (d){d3.select(this).style("stroke-width", "3px").style("stroke","none")}
    //actual histo
      bar.append("rect").attr("class","rect_histo")
        .attr("x", function(d) { return x_exp(d.eod); })
        .attr("width", x_exp.bandwidth()/1.5)
        .attr("rx", 2) //smoothness del rettangolo
        .attr("ry", 2)
        .attr("fill", function(d){
            if(d.eod.includes("enabled")) return "green"
            if(d.eod.includes("disabled")) return "red"
            return "#69b3a2"
            
        })
        // no bar at the beginning thus:
        .attr("height", function(d) { return heightexp - y_exp(0); }) // always equal to 0
        .attr("y", function(d) { return y_exp(0); })
        .on("click",expandBar)
        .on("mouseover",MoverBar)
        .on("mouseleave",MleaveBar)

        //label eod
    bar.append("text")
        .text(function(d) { return d.Value })
        .attr("x",function(d){return x_exp(d.eod)+5})
        .attr("y",function(d){return y_exp(d.Value)-2})
        .attr("font-family" , "sans-serif")
        .attr("font-size" , "14px")
        .attr("fill" , "black")
        .attr("text-anchor", "start");

    
    // Animation
    svg_single_chart.selectAll("rect")
      .transition()
      .duration(800)
      .attr("y", function(d) { return y_exp(d.Value); })
      .attr("height", function(d) { return heightexp - y_exp(d.Value); })
      .delay(function(d,i){return(i*100)})
   
    
    
}
    </script>